<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Insumos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .add-button {
            margin: 20px 0;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        input, select {
            margin: 5px 0;
            padding: 5px;
            width: calc(100% - 22px);
        }
        button[type="submit"] {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .status {
            margin: 10px;
            padding: 5px;
            color: white;
            border-radius: 4px;
            display: inline-block;
        }
        .status-ok {
            background-color: green;
        }
        .status-pending {
            background-color: red;
        }
        .status-defeito {
            background-color: orange;
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
    <h1>Lista de Insumos</h1>

    <!-- Filtros -->
    <label for="filtroSetor">Filtrar por Setor:</label>
    <select id="filtroSetor">
        <option value="">Todos</option>
        <option value="Bios">Bios</option>
        <option value="RMA">RMA</option>
        <option value="OpenBox">OpenBox</option>
    </select>

    <label for="filtroCategoria">Filtrar por Categoria:</label>
    <select id="filtroCategoria">
        <option value="">Todos</option>
        <option value="Processador">Processador</option>
        <option value="Memória">Memória</option>
        <option value="Placa de Vídeo">Placa de Vídeo</option>
        <option value="Armazenamento">Armazenamento</option>
          <option value="Air Cooler">Armazenamento</option>
          <option value="Fonte">Armazenamento</option>
    </select>

    <button class="add-button" id="openModalBtn">Adicionar Insumo</button>
    <table id="insumosTable">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Setor</th>
                <th>Confirmar Serial</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            <!-- Os itens serão adicionados aqui dinamicamente -->
        </tbody>
    </table>

    <!-- Modal para adicionar insumo -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">&times;</span>
            <form id="insumoForm">
                <input type="text" id="nome" placeholder="Nome" required>
                <select id="categoria" required>
                    <option value="" disabled selected>Categoria</option>
                    <option value="Processador">Processador</option>
                    <option value="Memória">Memória</option>
                    <option value="Placa de Vídeo">Placa de Vídeo</option>
                    <option value="Armazenamento">Armazenamento</option>
                    <option value="Air Cooler">Armazenamento</option>
                    <option value="Fonte">Armazenamento</option>
                </select>
                <select id="setor" required>
                    <option value="" disabled selected>Setor</option>
                    <option value="Bios">Bios</option>
                    <option value="RMA">RMA</option>
                    <option value="OpenBox">OpenBox</option>
                </select>
                <input type="text" id="serial" placeholder="Serial" required>
                <button type="submit">Adicionar Insumo</button>
            </form>
        </div>
    </div>

    <!-- Modal para ações -->
    <div id="actionsModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeActionsModalBtn">&times;</span>
            <h3>Escolha uma ação</h3>
            <form id="actionsForm">
                <input type="hidden" id="insumoIdAction">
                <select id="acao" required>
                    <option value="" disabled selected>Escolha uma ação</option>
                    <option value="transferir">Transferir para outro setor</option>
                    <option value="defeito">Marcar como defeituoso</option>
                </select>
                <select id="novoSetor" style="display:none;">
                    <option value="" disabled selected>Novo Setor</option>
                    <option value="Bios">Bios</option>
                    <option value="RMA">RMA</option>
                    <option value="OpenBox">OpenBox</option>
                </select>
                <button type="submit">Executar</button>
            </form>
        </div>
    </div>

    <!-- Modal para leitor de QR code -->
    <div id="qrcodeModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeQrCodeModalBtn">&times;</span>
            <div id="qr-reader" style="width:100%"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/parse/3.3.0/parse.min.js"></script>
    <script>
    // Configuração do Parse
    Parse.initialize("la2yMzwV7saXak9qzDTENoBCXAe4E0sk5JID8Fej", "Yh28SExwwjvbr7y2Ydtkc1nMOfu0pBoExO3TgDi5"); // Substitua pelos seus valores
    Parse.serverURL = "https://parseapi.back4app.com/";

    const senhaCorreta = "senha123"; // Defina a senha correta aqui

    async function listarInsumos() {
        const Insumo = Parse.Object.extend("Insumos");
        const query = new Parse.Query(Insumo);
        const filtroSetor = document.getElementById('filtroSetor').value;
        const filtroCategoria = document.getElementById('filtroCategoria').value;

        if (filtroSetor) {
            query.equalTo("setor", filtroSetor);
        }
        if (filtroCategoria) {
            query.equalTo("categoria", filtroCategoria);
        }

        try {
            const results = await query.find();
            const tabela = document.getElementById('insumosTable').getElementsByTagName('tbody')[0];
            tabela.innerHTML = ""; // Limpar a tabela antes de inserir novos dados
            results.forEach(insumo => {
                let linha = tabela.insertRow();
                let cellNome = linha.insertCell(0);
                let cellCategoria = linha.insertCell(1);
                let cellSetor = linha.insertCell(2);
                let cellConfirmar = linha.insertCell(3);
                let cellStatus = linha.insertCell(4);
                let cellAcoes = linha.insertCell(5);

                const insumoId = insumo.id;
                const serialReal = insumo.get("serial");
                const ultimoConferido = insumo.get("ultimoConferido");
                const hoje = new Date();
                const isSameWeek = ultimoConferido && new Date(ultimoConferido).getTime() >= getLastFriday().getTime();

                cellNome.textContent = insumo.get("nome");
                cellCategoria.textContent = insumo.get("categoria");
                cellSetor.textContent = insumo.get("setor");

                // Campo para confirmar serial
                let inputSerial = document.createElement("input");
                inputSerial.type = "text";
                inputSerial.placeholder = "Digite o serial";
                inputSerial.dataset.serialReal = serialReal;
                inputSerial.dataset.insumoId = insumoId;
                inputSerial.disabled = isSameWeek;
                cellConfirmar.appendChild(inputSerial);

                // Botão para iniciar o leitor de QR code
                let buttonQrcode = document.createElement("button");
                buttonQrcode.textContent = "Scan QR Code";
                buttonQrcode.onclick = function() {
                    abrirQrCodeModal(inputSerial);
                };
                buttonQrcode.disabled = isSameWeek;
                cellConfirmar.appendChild(buttonQrcode);

                // Botão para confirmar serial
                let buttonConfirmar = document.createElement("button");
                buttonConfirmar.textContent = "Confirmar";
                buttonConfirmar.onclick = function() {
                    confirmarSerial(inputSerial);
                };
                buttonConfirmar.disabled = isSameWeek;
                cellConfirmar.appendChild(buttonConfirmar);

                let status = insumo.get("status");
                cellStatus.id = `status-${insumoId}`;
                if (status === "ok") {
                    cellStatus.textContent = "Ok";
                    cellStatus.className = "status status-ok";
                } else if (status === "defeito") {
                    cellStatus.textContent = "Defeito";
                    cellStatus.className = "status status-defeito";
                } else {
                    cellStatus.textContent = "Pendente";
                    cellStatus.className = "status status-pending";
                }

                // Botão para ações
                let buttonAcoes = document.createElement("button");
                buttonAcoes.textContent = "Ações";
                buttonAcoes.onclick = function() {
                    abrirActionsModal(insumoId);
                };
                cellAcoes.appendChild(buttonAcoes);
            });
        } catch (error) {
            console.error("Erro ao listar insumos:", error);
        }
    }

    function getLastFriday() {
        let date = new Date();
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 5);
        date.setDate(diff);
        return new Date(date.setHours(0, 0, 0, 0));
    }

    function abrirQrCodeModal(inputSerial) {
        if (typeof Html5Qrcode === "undefined") {
            alert("Biblioteca de QR Code não carregada corretamente.");
            return;
        }

        document.getElementById('qrcodeModal').style.display = "block";
        const qrReader = new Html5Qrcode("qr-reader");
        qrReader.start(
            { facingMode: "environment" }, // Use rear camera
            {
                fps: 10,
                qrbox: 250
            },
            qrCodeMessage => {
                inputSerial.value = qrCodeMessage;
                confirmarSerial(inputSerial);
                qrReader.stop();
                closeQrCodeModal();
            },
            errorMessage => {
                console.log("QR Code no match.", errorMessage);
            })
            .catch(err => {
                console.log("Unable to start scanning.", err);
            });
    }

    function closeQrCodeModal() {
        document.getElementById('qrcodeModal').style.display = "none";
    }

    async function confirmarSerial(input) {
        const serialDigitado = input.value;
        const serialReal = input.dataset.serialReal;
        const insumoId = input.dataset.insumoId;

        if (serialDigitado === serialReal) {
            const Insumo = Parse.Object.extend("Insumos");
            const query = new Parse.Query(Insumo);
            try {
                const insumo = await query.get(insumoId);
                insumo.set("status", "ok");
                insumo.set("ultimoConferido", new Date().toISOString());
                await insumo.save();
                document.getElementById(`status-${insumoId}`).textContent = "Ok";
                document.getElementById(`status-${insumoId}`).className = "status status-ok";
                input.disabled = true;
                input.nextElementSibling.disabled = true;
                input.nextElementSibling.nextElementSibling.disabled = true;
            } catch (error) {
                console.error("Erro ao atualizar status do insumo:", error);
            }
        } else {
            alert("Serial incorreto. Por favor, tente novamente.");
        }
    }

    function abrirActionsModal(insumoId) {
        document.getElementById('insumoIdAction').value = insumoId;
        document.getElementById('actionsModal').style.display = "block";
    }

    function closeActionsModal() {
        document.getElementById('actionsModal').style.display = "none";
    }

    function openModal() {
        document.getElementById('myModal').style.display = "block";
    }

    function closeModal() {
        document.getElementById('myModal').style.display = "none";
    }

    document.getElementById('openModalBtn').addEventListener('click', openModal);
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('closeActionsModalBtn').addEventListener('click', closeActionsModal);
    document.getElementById('closeQrCodeModalBtn').addEventListener('click', closeQrCodeModal);

    window.onclick = function(event) {
        if (event.target == document.getElementById('myModal')) {
            closeModal();
        } else if (event.target == document.getElementById('actionsModal')) {
            closeActionsModal();
        } else if (event.target == document.getElementById('qrcodeModal')) {
            closeQrCodeModal();
        }
    }

    document.getElementById('insumoForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const nome = document.getElementById('nome').value;
        const categoria = document.getElementById('categoria').value;
        const setor = document.getElementById('setor').value;
        const serial = document.getElementById('serial').value;

        const Insumo = Parse.Object.extend("Insumos");
        const insumo = new Insumo();

        insumo.set("nome", nome);
        insumo.set("categoria", categoria);
        insumo.set("setor", setor);
        insumo.set("serial", serial);
        insumo.set("status", "pendente");

        try {
            await insumo.save();
            listarInsumos();
            closeModal();
        } catch (error) {
            console.error("Erro ao adicionar insumo:", error);
        }
    });

    document.getElementById('actionsForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const insumoId = document.getElementById('insumoIdAction').value;
        const acao = document.getElementById('acao').value;
        const novoSetor = document.getElementById('novoSetor').value;

        const Insumo = Parse.Object.extend("Insumos");
        const query = new Parse.Query(Insumo);

        try {
            const insumo = await query.get(insumoId);

            if (acao === "transferir") {
                if (!novoSetor) {
                    alert("Por favor, selecione o novo setor.");
                    return;
                }
                insumo.set("setor", novoSetor);
            } else if (acao === "defeito") {
                insumo.set("status", "defeito");
            }

            await insumo.save();
            listarInsumos();
            closeActionsModal();
        } catch (error) {
            console.error("Erro ao executar ação:", error);
        }
    });

    document.getElementById('acao').addEventListener('change', function() {
        const novoSetor = document.getElementById('novoSetor');
        if (this.value === "transferir") {
            novoSetor.style.display = "block";
        } else {
            novoSetor.style.display = "none";
        }
    });

    document.getElementById('filtroSetor').addEventListener('change', listarInsumos);
    document.getElementById('filtroCategoria').addEventListener('change', listarInsumos);

    // Inicializar a lista de insumos ao carregar a página
    listarInsumos();
    </script>
</body>
</html>
